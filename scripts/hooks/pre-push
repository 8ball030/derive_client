#!/usr/bin/env bash

# Git pre-push hook that parses and runs CI checks from GitHub Actions workflow files
# Save this file as .git/hooks/pre-push and make it executable: chmod +x .git/hooks/pre-push

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸš€ Running pre-push CI checks from workflow files...${NC}\n"

# Find workflow files
WORKFLOW_DIR=".github/workflows"
if [ ! -d "$WORKFLOW_DIR" ]; then
    echo -e "${RED}Error: $WORKFLOW_DIR directory not found${NC}"
    exit 1
fi

# Track failures
FAILED=0

# Function to extract and run commands from workflow file
parse_and_run_workflow() {
    local workflow_file=$1
    
    echo -e "${BLUE}ðŸ“„ Processing: $(basename $workflow_file)${NC}"
    
    # Extract step names and run commands using Python
    python3 - "$workflow_file" <<'PYTHON_SCRIPT'
import sys
import yaml
import subprocess
import re

def extract_commands(workflow_file):
    """Extract step names and run commands from GitHub Actions workflow."""
    with open(workflow_file, 'r') as f:
        try:
            workflow = yaml.safe_load(f)
        except yaml.YAMLError as e:
            print(f"Error parsing YAML: {e}")
            return []
    
    commands = []
    
    # Navigate through jobs
    if 'jobs' not in workflow:
        return commands
    
    for job_name, job_data in workflow['jobs'].items():
        if 'steps' not in job_data:
            continue
            
        for step in job_data['steps']:
            # Skip setup steps (install, checkout, etc.)
            step_name = step.get('name', '').lower()
            if any(skip in step_name for skip in ['checkout', 'setup', 'install', 'cache', 'download']):
                continue
            
            # Extract run commands
            if 'run' in step:
                run_cmd = step['run'].strip()
                # Skip if it's just installing things
                if any(install in run_cmd.lower() for install in ['apt-get', 'pip install', 'poetry install']):
                    continue
                    
                commands.append({
                    'name': step.get('name', 'Unnamed step'),
                    'command': run_cmd
                })
    
    return commands

def run_command(name, command):
    """Run a command and return success status."""
    print(f"\n\033[1;33mâ–¶ Running {name}...\033[0m")
    
    # Handle multi-line commands
    lines = [line.strip() for line in command.split('\n') if line.strip()]
    
    for line in lines:
        # Skip comments
        if line.startswith('#'):
            continue
            
        print(f"  $ {line}")
        result = subprocess.run(line, shell=True, executable='/bin/bash')
        if result.returncode != 0:
            print(f"\033[0;31mâœ— {name} failed\033[0m")
            return False
    
    print(f"\033[0;32mâœ“ {name} passed\033[0m")
    return True

# Main execution
workflow_file = sys.argv[1]
commands = extract_commands(workflow_file)

if not commands:
    print(f"No commands to run from {workflow_file}")
    sys.exit(0)

failed = False
for cmd_info in commands:
    if not run_command(cmd_info['name'], cmd_info['command']):
        failed = True

sys.exit(1 if failed else 0)
PYTHON_SCRIPT

    if [ $? -ne 0 ]; then
        FAILED=1
    fi
}

# Check if PyYAML is available
if ! python3 -c "import yaml" 2>/dev/null; then
    echo -e "${RED}Error: PyYAML not installed. Install with: pip install pyyaml${NC}"
    echo -e "${YELLOW}Alternatively, skip this check with: git push --no-verify${NC}"
    exit 1
fi

# Process each workflow file (or specify which ones to use)
for workflow in "$WORKFLOW_DIR"/*.yml "$WORKFLOW_DIR"/*.yaml; do
    if [ -f "$workflow" ]; then
        parse_and_run_workflow "$workflow" || true
    fi
done

# Summary
echo -e "\n${BLUE}================================${NC}"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All checks passed! Proceeding with push...${NC}"
    exit 0
else
    echo -e "${RED}âœ— Some checks failed. Push aborted.${NC}"
    echo -e "${YELLOW}Fix the issues above or use 'git push --no-verify' to skip checks.${NC}"
    exit 1
fi